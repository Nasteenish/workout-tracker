<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#08080F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/styles.css?v=26">
    <title>Трекер Тренировок</title>
</head>
<body>
    <div id="app"></div>
    <div id="debug" style="position:fixed;bottom:0;left:0;right:0;background:#300;color:#f88;font-size:11px;padding:4px 8px;max-height:30vh;overflow:auto;z-index:9999;display:none"></div>
    <div id="notif-diag" style="position:fixed;top:60px;left:10px;right:10px;background:#1a1a2e;border:1px solid #444;border-radius:12px;padding:16px;z-index:10000;color:#eee;font-size:14px;display:none">
        <div id="diag-status" style="margin-bottom:12px;white-space:pre-line"></div>
        <button id="diag-test" style="width:100%;padding:12px;background:#c3ff3c;color:#000;border:none;border-radius:8px;font-size:16px;font-weight:600">Отправить тест-уведомление</button>
        <button id="diag-close" style="width:100%;padding:10px;background:#333;color:#fff;border:none;border-radius:8px;font-size:14px;margin-top:8px">Закрыть</button>
    </div>

    <script>
        // Show JS errors on screen
        window.onerror = function(msg, src, line, col, err) {
            var d = document.getElementById('debug');
            d.style.display = 'block';
            d.innerHTML += '<b>ERROR:</b> ' + msg + '<br>at ' + src + ':' + line + '<br>';
            return false;
        };
    </script>

    <script src="./js/utils.js?v=14"></script>
    <script src="./js/data.js?v=16"></script>
    <script src="./js/storage.js?v=15"></script>
    <script src="./js/ui.js?v=31"></script>
    <script src="./js/timer.js?v=30"></script>
    <script src="./js/app.js?v=47"></script>

    <script>
        // Notification diagnostic — shows automatically on load
        (function() {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    var panel = document.getElementById('notif-diag');
                    var status = document.getElementById('diag-status');
                    panel.style.display = 'block';
                    var lines = [];
                    lines.push('Notification API: ' + ('Notification' in window ? 'YES' : 'NO'));
                    lines.push('Permission: ' + (('Notification' in window) ? Notification.permission : 'N/A'));
                    lines.push('SW support: ' + ('serviceWorker' in navigator ? 'YES' : 'NO'));
                    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                        lines.push('SW controller: ACTIVE ✓');
                    } else {
                        lines.push('SW controller: NONE ✗');
                    }
                    navigator.serviceWorker.ready.then(function(reg) {
                        lines.push('SW ready: ' + (reg.active ? 'ACTIVE ✓' : 'NO'));
                        lines.push('SW scope: ' + reg.scope);
                        status.textContent = lines.join('\n');
                    }).catch(function(e) {
                        lines.push('SW ready error: ' + e.message);
                        status.textContent = lines.join('\n');
                    });
                    status.textContent = lines.join('\n');
                }, 2000);
            });
            document.addEventListener('click', function(e) {
                if (e.target.id === 'diag-close') {
                    document.getElementById('notif-diag').style.display = 'none';
                }
                if (e.target.id === 'diag-test') {
                    var st = document.getElementById('diag-status');
                    navigator.serviceWorker.ready.then(function(reg) {
                        if (reg.active) {
                            reg.active.postMessage({ type: 'TEST_NOTIFICATION' });
                            st.textContent += '\n\nTEST_NOTIFICATION отправлен → жди уведомление!';
                        } else {
                            st.textContent += '\n\nОШИБКА: SW не активен';
                        }
                    }).catch(function(e) {
                        st.textContent += '\n\nОШИБКА: ' + e.message;
                    });
                }
            });
        })();
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            // One-time SW reset to clear corrupted state after rapid updates
            if (!localStorage.getItem('_swReset149')) {
                navigator.serviceWorker.getRegistrations().then(function(regs) {
                    return Promise.all(regs.map(function(r) { return r.unregister(); }));
                }).then(function() {
                    localStorage.setItem('_swReset149', '1');
                    return navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' });
                }).then(function(reg) { return reg.update(); });
            } else {
                navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
                    .then(function(reg) { return reg.update(); });
            }
        }
    </script>
</body>
</html>
